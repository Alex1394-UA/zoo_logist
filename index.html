<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü–æ–º—ñ—á–Ω–∏–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .upload-area {
        border: 2px dashed rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .upload-area:hover {
        border-color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.05);
      }
      .upload-area.dragover {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }
      input[type="file"] {
        display: none;
      }
      button {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .status.success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.5);
      }
      .status.error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.5);
      }
      .status.info {
        background: rgba(33, 150, 243, 0.2);
        border: 1px solid rgba(33, 150, 243, 0.5);
      }
      .preview {
        margin: 20px 0;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }
      .preview table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      .preview th,
      .preview td {
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px;
        text-align: left;
      }
      .preview th {
        background: rgba(255, 255, 255, 0.1);
        font-weight: bold;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .instructions {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìä –ü–æ–º—ñ—á–Ω–∏–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º</h1>

      <div class="instructions">
        <h3>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó:</h3>
        <p>1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –≤–∞—à CSV —Ñ–∞–π–ª –∑ –¥–∞–Ω–∏–º–∏ –ø—Ä–æ —Ä—É—Ö —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞ —Ç–∏–∂–¥–µ–Ω—å</p>
        <p>
          2. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–±—Ä–æ–±–∏—Ç—å –¥–∞–Ω—ñ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π Excel
          —Ñ–∞–π–ª
        </p>
        <p>
          3. –£ —Ä–µ–∑—É–ª—å—Ç—É—é—á–æ–º—É —Ñ–∞–π–ª—ñ –±—É–¥—É—Ç—å –∫–æ–ª–æ–Ω–∫–∏: –ú–∞—Ä–∫–∞, –í–∏–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∏,
          –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É, –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫, –ü—Ä–∏—Ö—ñ–¥, –í–∏—Ç—Ä–∞—Ç–∞, –ö—ñ–Ω—Ü–µ–≤–∏–π
          –∑–∞–ª–∏—à–æ–∫
        </p>
      </div>

      <div
        class="upload-area"
        id="uploadArea"
        onclick="document.getElementById('fileInput').click()"
      >
        <p>üóÇÔ∏è –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Ç—É—Ç –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª CSV –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
        <p style="font-size: 14px; opacity: 0.8">–ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è —Ñ–∞–π–ª–∏ .csv</p>
      </div>

      <input type="file" id="fileInput" accept=".csv" />

      <div id="status"></div>

      <div class="stats" id="stats" style="display: none">
        <div class="stat-card">
          <div class="stat-number" id="totalRecords">0</div>
          <div>–£—Å—å–æ–≥–æ –∑–∞–ø–∏—Å—ñ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalBrands">0</div>
          <div>–ë—Ä–µ–Ω–¥—ñ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCategories">0</div>
          <div>–ö–∞—Ç–µ–≥–æ—Ä—ñ–π</div>
        </div>
      </div>

      <div id="preview" class="preview" style="display: none"></div>

      <button id="downloadBtn" onclick="downloadExcel()" style="display: none">
        üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª Excel
      </button>
    </div>

    <script>
      let processedData = [];

      // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");

      // Drag and drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      function showStatus(message, type = "info") {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function cleanNumber(value) {
        if (!value || value === "") return 0;
        return parseFloat(value.toString().replace(",", ".")) || 0;
      }

      function handleFile(file) {
        if (!file.name.toLowerCase().endsWith(".csv")) {
          showStatus("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å CSV —Ñ–∞–π–ª", "error");
          return;
        }

        showStatus("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –æ–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É...", "info");

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          processCSVData(content);
        };
        reader.readAsText(file, "utf-8");
      }

      function processCSVData(content) {
        try {
          const parsedData = Papa.parse(content, {
            delimiter: ",",
            skipEmptyLines: false,
            dynamicTyping: false,
          });

          // –ó–Ω–∞–π–¥–µ–º–æ —Ä—è–¥–æ–∫ —ñ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
          let headerRowIndex = -1;
          for (let i = 0; i < parsedData.data.length; i++) {
            const row = parsedData.data[i];
            if (
              row.some(
                (cell) => cell && cell.toString().includes("–ù–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫"), // –Ω–∞–∑–≤–∞ —è—á–µ–π–∫–∏ —è–∫ —É –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–º—É —Ñ–∞–π–ª—ñ, –Ω–µ –ø–µ—Ä–µ–∫–ª–∞–¥–∞—î–º–æ
              )
            ) {
              headerRowIndex = i;
              break;
            }
          }

          if (headerRowIndex === -1) {
            showStatus("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ñ –≤ CSV —Ñ–∞–π–ª—ñ", "error");
            return;
          }

          let finalData = [];
          let currentBrand = "";
          let currentCategory = "";

          // –û–±—Ä–æ–±–ª—è—î–º–æ –¥–∞–Ω—ñ
          for (let i = headerRowIndex + 1; i < parsedData.data.length; i++) {
            const row = parsedData.data[i];

            // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø—É—Å—Ç—ñ —Ä—è–¥–∫–∏
            if (row.every((cell) => !cell || cell.trim() === "")) continue;

            const hasFirstCol = row[0] && row[0].trim() !== "";
            const hasNumbers = row[4] || row[6] || row[7] || row[8];

            if (hasFirstCol && hasNumbers) {
              const productName = row[0].trim();
              const startBalance = cleanNumber(row[4]);
              const income = cleanNumber(row[6]);
              const expense = cleanNumber(row[7]);
              const endBalance = cleanNumber(row[8]);

              // –í–∏–∑–Ω–∞—á–∞—î–º–æ –±—Ä–µ–Ω–¥–∏
              const isBrand =
                productName.length < 30 &&
                ([
                  "ACANA",
                  "AnimAll",
                  "Bayer",
                  "BOSCH",
                  "Brit Care",
                  "Carnilove",
                  "Cat Chow",
                ].includes(productName) ||
                  productName.toUpperCase() === productName ||
                  /^[A-Z][a-zA-Z\s&\.]+$/.test(productName));

              if (isBrand) {
                currentBrand = productName;
                currentCategory = "";
              } else {
                // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
                const categoryKeywords = [
                  "–¥–ª—è –∫–æ—Ç—ñ–≤",
                  "–¥–ª—è —Å–æ–±–∞–∫",
                  "–ª–∞—Å–æ—â—ñ",
                  "–∫–æ—Ä–º",
                  "–∑–∞—Å–æ–±–∏",
                  "—à–∞–º–ø—É–Ω—å",
                  "–∫–æ–Ω—Å–µ—Ä–≤–∞",
                  "–Ω–∞–ø–æ–≤–Ω—é–≤–∞—á",
                  "–ø—Ä–æ—Ç–∏–ø–∞—Ä–∞–∑–∏—Ç–Ω—ñ",
                  "–ø–æ–≤–æ–¥–∫–∏, —Ä—É–ª–µ—Ç–∫–∏",
                ];
                const isCategory =
                  categoryKeywords.some((keyword) =>
                    productName.toLowerCase().includes(keyword),
                  ) &&
                  !productName.includes(" –≥") &&
                  !productName.includes("–∫–≥") &&
                  !productName.includes("–º–ª") &&
                  !productName.match(/\d/);

                if (isCategory && productName !== currentCategory) {
                  currentCategory = productName;
                } else if (!isCategory) {
                  // –¶–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ç–æ–≤–∞—Ä
                  // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞ –ø—Ä–∞–≤–∏–ª–æ–º –ø—ñ–≤—Ç–æ—Ä–∞
                  const targetStock = expense * 1.5; // –∑–∞–ø–∞—Å –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å + 50%
                  let recommendedOrder = Math.max(0, targetStock - endBalance);
                  if (recommendedOrder > 0 && recommendedOrder < 1) {
                    recommendedOrder = 1; // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–æ—Ä—ñ–≥
                  }

                  finalData.push({
                    brand: currentBrand || "–ë–µ–∑ –±—Ä–µ–Ω–¥–∞",
                    category: currentCategory || "–ó–∞–≥–∞–ª—å–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è",
                    productName: productName,
                    startBalance: startBalance,
                    income: income,
                    expense: expense,
                    endBalance: endBalance,
                    recommendedOrder: Math.round(recommendedOrder), // –æ–∫—Ä—É–≥–ª—é—î–º–æ –¥–æ —Ü—ñ–ª–æ–≥–æ
                  });
                }
              }
            }
          }

          processedData = finalData;

          // –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          const brands = [...new Set(finalData.map((item) => item.brand))];
          const categories = [
            ...new Set(finalData.map((item) => item.category)),
          ];

          document.getElementById("totalRecords").textContent =
            finalData.length;
          document.getElementById("totalBrands").textContent = brands.length;
          document.getElementById("totalCategories").textContent =
            categories.length;
          document.getElementById("stats").style.display = "grid";

          // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
          showPreview(finalData.slice(0, 20));

          showStatus(
            `–£—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ ${finalData.length} –∑–∞–ø–∏—Å—ñ–≤ —Ç–æ–≤–∞—Ä—ñ–≤`,
            "success",
          );
          document.getElementById("downloadBtn").style.display = "block";
        } catch (error) {
          showStatus(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ —Ñ–∞–π–ª—É: ${error.message}`, "error");
        }
      }

      function showPreview(data) {
        const previewDiv = document.getElementById("preview");

        let html = "<h3>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ (–ø–µ—Ä—à—ñ 20 –∑–∞–ø–∏—Å—ñ–≤):</h3>";
        html += "<table>";
        html +=
          "<tr><th>–ú–∞—Ä–∫–∞</th><th>–í–∏–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∏</th><th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É</th><th>–ù–∞—á. –∑–∞–ª–∏—à–æ–∫</th><th>–ü—Ä–∏—Ö–æ–¥</th><th>–í–∏—Ç—Ä–∞—Ç–∞</th><th>–ö—ñ–Ω. –∑–∞–ª–∏—à–æ–∫</th><th>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∑–∞–º–æ–≤–∏—Ç–∏</th></tr>";

        data.forEach((item) => {
          html += `<tr>
						<td>${item.brand}</td>
						<td>${item.category}</td>
						<td>${item.productName}</td>
						<td>${item.startBalance}</td>
						<td>${item.income}</td>
						<td>${item.expense}</td>
						<td>${item.endBalance}</td>
						<td>${item.recommendedOrder}</td>
					</tr>`;
        });

        html += "</table>";
        previewDiv.innerHTML = html;
        previewDiv.style.display = "block";
      }

      function downloadExcel() {
        if (processedData.length === 0) {
          showStatus("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è", "error");
          return;
        }

        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª Excel
        const workbook = XLSX.utils.book_new();

        // –ü—ñ–¥–≥–æ—Ç–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ
        const excelData = [
          [
            "–ú–∞—Ä–∫–∞",
            "–í–∏–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∏",
            "–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É",
            "–ù–∞—á–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫",
            "–ü—Ä–∏—Ö–æ–¥",
            "–í–∏—Ç—Ä–∞—Ç–∞",
            "–ö—ñ–Ω—Ü–µ–≤–∏–π –∑–∞–ª–∏—à–æ–∫",
            "–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∑–∞–º–æ–≤–∏—Ç–∏",
          ],
        ];

        processedData.forEach((item) => {
          excelData.push([
            item.brand,
            item.category,
            item.productName,
            item.startBalance,
            item.income,
            item.expense,
            item.endBalance,
            item.recommendedOrder,
          ]);
        });

        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ä–æ–±–æ—á–∏–π –ª–∏—Å—Ç
        const worksheet = XLSX.utils.aoa_to_sheet(excelData);

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
        const colWidths = [
          { wch: 20 }, // –ú–∞—Ä–∫–∞
          { wch: 30 }, // –í–∏–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∏
          { wch: 50 }, // –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É
          { wch: 15 }, // –ù–∞—á–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫
          { wch: 15 }, // –ü—Ä–∏—Ö–æ–¥
          { wch: 15 }, // –í–∏—Ç—Ä–∞—Ç–∞
          { wch: 15 }, // –ö—ñ–Ω—Ü–µ–≤–∏–π –∑–∞–ª–∏—à–æ–∫
          { wch: 20 }, // –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∑–∞–º–æ–≤–∏—Ç–∏
        ];
        worksheet["!cols"] = colWidths;

        // –î–æ–¥–∞—î–º–æ –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É
        XLSX.utils.book_append_sheet(workbook, worksheet, "–õ–æ–≥—ñ—Å—Ç–∏–∫–∞");

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª
        XLSX.writeFile(workbook, "logist_optimised.xlsx");

        showStatus(
          `Excel —Ñ–∞–π–ª "logist_optimised.xlsx" —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!`,
          "success",
        );
      }
    </script>
  </body>
</html>
